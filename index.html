<!DOCTYPE html>
<html lang="zh-TW" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ğŸMapleStory Astarå…¬æœƒå°ˆå±¬ç¶²ç«™ğŸ</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  
  <!-- Bootstrap JS (Modal éœ€è¦) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <style>
    body 
    {
      overflow-y: scroll;
      margin: 0;
      padding: 0;
    }
  
    .status-badge { font-size: 0.85rem; }
    .group-row { background: rgba(0,0,0,.03); font-weight: 600; }
    button.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
    #sourceBadge { display: none !important; }
    
    <!-- /* åˆ†é å¤–æ¡† + é¡è‰² */ -->
    .nav-tabs-custom .nav-link
    {
      border:2px solid transparent;
      font-weight:600;
      margin-right:.5rem;
    }
    .nav-tabs-custom .nav-link:hover
    {
      opacity:.9;
    }
  
    <!-- /* æ™®é€šæ‹‰åœ–æ–¯ï¼ˆè—ï¼‰ */ -->
    .nav-tabs-custom .tab-latus{
    color:#0d6efd;
    border-color:#0d6efd;
    }
    .nav-tabs-custom .tab-latus.active{
    color:#fff;
    background:#0d6efd;
    }
    
    <!-- /* å›°è—æ‹‰åœ–æ–¯ï¼ˆç´«ï¼‰ */ -->
    .nav-tabs-custom .tab-latushard{
    color:#6f42c1;
    border-color:#6f42c1;
    }
    .nav-tabs-custom .tab-latushard.active{
    color:#fff;
    background:#6f42c1;
    } 
  
    <!-- /* æ®˜æš´ç‚é­”ï¼ˆæ©˜ï¼‰ */ -->
    .nav-tabs-custom .tab-zakum{
    color:#fd7e14;
    border-color:#fd7e14;
    }
    .nav-tabs-custom .tab-zakum.active{
    color:#fff;
    background:#fd7e14;
    }
  
    <!-- /* è¨“ç·´ç‡Ÿ&å¤–æ´ï¼ˆç¶ ï¼‰ */ -->
    .nav-tabs-custom .tab-misc{
    color:#198754;
    border-color:#198754;
    }
    .nav-tabs-custom .tab-misc.active{
    color:#fff;
    background:#198754;
    }
    /* å”å”ä¸€åœ–æµï¼ˆæ©˜ï¼‰ */
    .nav-tabs-custom .tab-onep{
      color:#fd7e14;
      border-color:#fd7e14;
    }
    .nav-tabs-custom .tab-onep.active{
      color:#fff;
      background:#fd7e14;
    }
        
    .title{font-weight:bold; font-size:1.0rem;}
    
    <!-- /* é‡å°æ¨™ç±¤å…§çš„å…§å®¹é€²è¡Œé‡è£½ */ -->
    .reset-content 
    {
      <!-- /* all: revert; */ -->   
      display: table-cell;  
      line-height: 1.5; 
      font-size: 1rem;    
      padding: 0.5;           
      border: none;         
    }
  
    <!-- /* å¦‚æœæ˜¯é‡å°æ•´å€‹è¡¨æ ¼ï¼Œå¯ä»¥æ›´ç°¡å–® */ -->
    .clean-table 
    {
      all: revert;
      width: 100%;
      border-collapse: collapse;
    }
	
	/* è§’è‰²åç¨±å³å´çš„å°å•è™ŸæŒ‰éˆ• */
	.name-history-btn{
	  display:inline-flex; align-items:center; justify-content:center;
	  width:22px; height:22px; line-height:22px;
	  border-radius:50%; border:0;
	  background:#ffc107; color:#212529; font-weight:700;
	  cursor:pointer; margin-left:.25rem;
	}
	.name-history-btn:hover{ filter: brightness(0.95); }
	/* è§’è‰²æ¸…å–®å·¥å…·åˆ—ï¼šè®“æœå°‹æ¡†ä¸è¦æŠŠæ’ç‰ˆæ’é–‹ */
	.toolbar-compact{ gap:.5rem; flex-wrap:wrap; }
	.toolbar-compact .search-group{
	  width:180px;          /* å›ºå®šçª„å¯¬ */
	  flex:0 0 auto;        /* ä¸è¦ä¼¸å±• */
	}
	.toolbar-compact .search-group input{ min-width:0; } /* é˜²æ­¢è¢«å…§å®¹æ’å¤§ */
	@media (max-width:576px){
	  .toolbar-compact .search-group{ width:150px; }     /* æ‰‹æ©Ÿå†å°ä¸€é» */
	}
	/* æ²åˆ°åˆ—å¾Œçš„é«˜äº®å‹•ç•« */
	.row-pulse {
	  animation: rowPulse 2s ease-out 0s 1;
	}
	@keyframes rowPulse {
	  0%   { background-color: #fff3cd; }   /* æ·¡é»ƒ */
	  50%  { background-color: #ffe8a1; }
	  100% { background-color: transparent; }
	}
  </style>
</head>

<body class="bg-body">
  <nav class="navbar navbar-expand-lg bg-primary navbar-dark sticky-top" style="padding:3px">
    <div class="container-fluid">
    <span class="navbar-brand btn-sm title" style="font-size:1.25rem;">ğŸMapleStory Astarå…¬æœƒå°ˆå±¬ç¶²ç«™ğŸ-1621</span>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="sourceBadge" class="badge bg-light text-dark status-badge">sheetId=1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs | gid=0</span>
      <!-- å°å¤¥ä¼´æ¸…å–® -->
      <button id="backToList" class="btn btn-outline-light btn-sm title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å…¬æœƒå°å¤¥ä¼´</button>
      <!-- éŠæˆ²æ”»ç•¥ -->
      <button id="Guide" class="btn btn-outline-light btn-sm title">ğŸš€ éŠæˆ²æ”»ç•¥</button>
      <!-- æ¥“ä¹‹è°·åœ–é‘‘  -->
      <a href="https://www.artalemaplestory.com/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm title" title="æ¥“ä¹‹è°·åœ–é‘‘">ğŸ æ¥“ä¹‹è°·åœ–é‘‘</a>
      <!-- ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å° -->
      <a href="https://artale-market.org/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm title" title="ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å°">ğŸª ç¬¬ä¸‰æ–¹äº¤æ˜“å¹³å°</a>
      <!-- æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·æŒ‰éˆ•ï¼ˆæ€ªç‰©åœ–æ¡ˆï¼‰ -->
      <a href="https://a2983456456.github.io/artale-drop/" target="_blank" rel="noopener noreferrer" class="btn btn-outline-light btn-sm title" title="æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·">ğŸ‘¾ æ€ªç‰©æ‰è½ç‰©æŸ¥è©¢å·¥å…·</a>
      <!-- å¤œé–“æ¨¡å¼ -->
      <button id="toggleTheme" class="btn btn-outline-light btn-sm title"">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
    </div>
    </div>
  </nav>

  <!-- å…¬æœƒå°å¤¥ä¼´ -->
  <div id="homePage" class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="mb-0"><b>ğŸ‘©â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å…¬æœƒå°å¤¥ä¼´</b></h3>
    </div>
    
    <!-- æç¤ºå¡ç‰‡ -->
    <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-0">
        <h4 class="card-title mb-2">â¡ï¸ è³‡æ–™ä¾†æº</h4>
      </div>
      <p class="mb-0 text-muted">è«‹å„ä½æª¢è¦–ä¸€ä¸‹è‡ªå·±çš„è³‡æ–™æ˜¯å¦é ˆæ›´æ–°ï¼Œè‹¥è¦æ›´æ–°è«‹é»æ“Šã€ä¿®æ”¹ã€‘æŒ‰éˆ•é€²è¡Œæ›´æ–°ã€‚è‹¥é‡ç„¡æ³•æ›´æ–°æƒ…å½¢è«‹é€²ä»¥ä¸‹ç¶²å€é€²å…¥Excelè¡¨æ‰¾åˆ°è‡ªå·±çš„æ¬„ä½æ›´æ–°è³‡æ–™ ã€€ï½æ„Ÿæ©çš„å¿ƒï½</p>
      <small class="text-muted">
      <a href="https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0" target="_blank" rel="noopener noreferrer">
        https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0
      </a>
      </small>
      <div id="msg" class="text-danger mt-2"></div>
    </div>
    </div>
	<div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-2">
		  <h4 class="card-title mb-2 mb-sm-0">ğŸ‹ï¸ è§’è‰²æ¸…å–®</h4>
		  <!-- å³å´å·¥å…·åˆ—ï¼šæ¨åˆ°æœ€å³ã€å¯è‡ªå‹•æ›è¡Œï¼›æœå°‹æ¡†ä¸æ’é–‹ -->
		  <div class="d-flex align-items-center gap-2 flex-wrap ms-auto" style="min-width:0;">
			<button id="addBtn" class="btn btn-primary btn-sm">æ–°å¢è§’è‰²</button>

			<!-- æœå°‹æ¡†ï¼ˆå›ºå®šå¯¬åº¦ã€ä¸ä¼¸å±•ï¼‰ -->
			<div class="input-group input-group-sm" style="width: 200px; flex: 0 0 auto;">
			  <input id="charSearchInput" type="text" class="form-control w-auto" placeholder="æœå°‹è§’è‰²" style="min-width:0;">
			  <button id="charSearchBtn" class="btn btn-outline-secondary">æœå°‹</button>
			</div>

			<a class="btn btn-outline-success btn-sm" href="https://docs.google.com/forms/d/e/1FAIpQLSf8cD32ZkhEh38MIL2bHP3Rypm1fWdmCDzlzuEKkxdQLlgkTg/viewform" target="_blank" rel="noopener noreferrer">åƒåŠ ç‹åœ˜æ„é¡˜å¡«å¯«è¡¨</a>
			<button id="btnJobStats" class="btn btn-outline-primary btn-sm">ğŸ“Š å…¬æœƒè·æ¥­åˆ†ä½ˆçµ±è¨ˆ</button>
			<button id="reloadBtn" class="btn btn-outline-secondary btn-sm">é‡æ–°æ•´ç†</button>
		  </div>
		</div>
    </div>
      <!-- â˜… æ–°å¢ï¼šåˆ†é åˆ‡æ›ï¼ˆåƒ…åˆ‡æ›é¡¯ç¤ºç‡Ÿå€ï¼‰ -->
      <ul class="nav nav-pills nav-tabs-custom mb-3" id="campTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button id="tabLatus" class="nav-link tab-latus active" type="button" role="tab">æ‹‰åœ–æ–¯(æ™®é€š)</button>
        </li>
        <!-- æ”¾åœ¨ id="tabLatus" ä¹‹å¾Œã€id="tabZakumList" ä¹‹å‰ -->
        <li class="nav-item" role="presentation">
          <button id="tabLatusHard" class="nav-link tab-latushard" type="button" role="tab">æ‹‰åœ–æ–¯(å›°é›£)</button>
        </li>
        <li class="nav-item" role="presentation">
          <button id="tabZakumList" class="nav-link tab-zakum" type="button" role="tab">æ®˜æš´ç‚é­”</button>
        </li>
        <li class="nav-item" role="presentation">
          <button id="tabTrainExt" class="nav-link tab-misc" type="button" role="tab">è¨“ç·´ç‡Ÿ&å¤–æ´å°ˆå€</button>
        </li>
      </ul>
  
      <!-- è…³è‰²è¡¨æ ¼ -->
      <div class="table-responsive">
      <table class="table table-striped table-hover align-middle reset-content">
        <thead class="table-secondary">
        <tr>
          <th style="width: 20%;">è§’è‰²åç¨±</th>
          <th style="width: 10%;">è§’è‰²ä»£ç¢¼</th>
          <th style="width: 20%;">è§’è‰²è·æ¥­</th>
          <th style="width: 10%;">è§’è‰²ç­‰ç´š</th>
          <th style="width: 10%;">è§’è‰²ä¹¾è¡¨</th>
          <th style="width: 20%;">æ‰€åœ¨ç‡Ÿå€</th>
          <th style="width: 10%;">ä¿®æ”¹è³‡æ–™</th>
        </tr>
        </thead>
        <tbody id="tableBody">
        <tr>
          <td colspan="7" class="text-center text-muted">å°šæœªè®€å–è³‡æ–™</td>
        </tr>
        </tbody>
      </table>
      </div>
    </div>
    </div>
  </div>

  <!-- éŠæˆ²æ”»ç•¥ -->
  <div id="GuidePage" class="container py-4 d-none">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="mb-0"><b>ğŸš€ éŠæˆ²æ”»ç•¥ï¼ˆGame Guideï¼‰<b></h3>
      <div class="d-flex align-items-center gap-2">
        <button id="backToList" class="btn btn-outline-secondary btn-sm">â† è¿”å›è§’è‰²æ¸…å–®</button>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
      <!-- å°è¦½æŒ‰éˆ•åˆ—ï¼ˆç”¨ button.nav-link å–ä»£ labelï¼‰ -->
<ul class="nav nav-pills nav-tabs-custom mb-3" id="guideTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <!-- å”å”ä¸€åœ–æµï¼šæ²¿ç”¨æ©˜è‰²é¢¨æ ¼ -->
    <button id="tabOneP" class="nav-link tab-onep active" type="button" role="tab" data-target="#pane-onep">
    å”å”ä¸€åœ–æµ
  </button>

  </li>

  <li class="nav-item" role="presentation">
    <!-- å¤–éƒ¨é€£çµå¯ç”¨ <a> ä»ä¿ç•™ nav-link è¦–è¦º -->
    <a class="nav-link tab-latus" role="tab" target="_blank" rel="noopener noreferrer"
       href="https://docs.google.com/spreadsheets/d/1lPS_dyOfFe04SbmavvqAZT6GVTOuN-F-qSXDhQlpfUY/edit?gid=0#gid=0">
      å…¨è·æ¥­æ”»ç•¥
    </a>
  </li>

  <li class="nav-item" role="presentation">
    <a class="nav-link tab-misc" role="tab" target="_blank" rel="noopener noreferrer"
       href="https://docs.google.com/document/u/0/d/1fripMi-WrPOh9ZpdAfUlyiUZd42Btt_tIpNohXLLE3A/mobilebasic">
      å…¨è·æ¥­å››è½‰æŠ€èƒ½
    </a>
  </li>

  <li class="nav-item" role="presentation">
    <a class="nav-link tab-misc" role="tab" target="_blank" rel="noopener noreferrer"
       href="https://rvgin.github.io/tower-of-goddess/">
      å¥³ç¥400å°å·¥å…·
    </a>
  </li>

  <li class="nav-item" role="presentation">
    <a class="nav-link tab-misc" role="tab" target="_blank" rel="noopener noreferrer"
       href="https://philipc-1.github.io/MapleStory/HPsimulator.html">
      è£œå“ç”Ÿå­˜æ¨¡æ“¬å™¨
    </a>
  </li>
  
  <li class="nav-item" role="presentation">
    <button id="tabLatusHardGuide" class="nav-link tab-latushard" type="button" role="tab"
            data-target="#pane-latus-hard">
      â°å›°é›£æ‹‰åœ–æ–¯
    </button>
  </li>
  
  <li class="nav-item" role="presentation">
    <button id="tabZakumGuide" class="nav-link tab-latushard" type="button" role="tab"
        data-target="#pane-zakum">
    ğŸ—¿æ®˜æš´ç‚é­”
  </button>

  </li>
</ul>

<!-- å…§å®¹é¢æ¿ï¼šç”¨ div.pane æ­é… d-none åˆ‡æ› -->
<div id="pane-onep" class="tab-pane">
  <!-- é€™è£¡æ”¾ä½ åŸæœ¬ã€Œå”å”ä¸€åœ–æµã€é¢æ¿ï¼ˆæœå°‹ã€è¡¨æ ¼ï¼‰å…§å®¹ -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="card-title mb-2">ğŸŒŸ å”å”ä¸€åœ–æµ</h4>
    <div class="d-flex align-items-center gap-2">
      <input type="text" name="txt_Search" style="min-width: 200px !important; display: block !important;" placeholder="è¼¸å…¥æœå°‹å…§å®¹">
      <button id="btn_SearchOneP" class="btn btn-outline-secondary btn-sm">æœå°‹</button>
      <button id="btn_ResetOneP" class="btn btn-outline-secondary btn-sm">é‡ç½®</button>
      <button id="reloadBtn_OneP" class="btn btn-outline-secondary btn-sm">é‡æ–°æ•´ç†</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle reset-content">
      <thead class="table-secondary">
        <tr>
          <th style="width: 20%;">åˆ†é¡</th>
          <th style="width: 20%;">åç¨±</th>
          <th style="width: 25%;">é—œéµå­—</th>
          <th style="width: 35%;">åœ–ç‰‡ (é»æ“Šé–‹å•Ÿå¤§åœ–)</th>
        </tr>
      </thead>
      <tbody id="tableBody_OneP">
        <tr>
          <td colspan="4" class="text-center text-muted">å°šæœªè®€å–è³‡æ–™</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="pane-latus-hard" class="tab-pane d-none">
  <h4 class="card-title mb-2">â° å›°é›£æ‹‰åœ–æ–¯æ”»ç•¥ï¼ˆHard Papulatus Guideï¼‰</h4>
  <div class="ratio ratio-16x9">
    <iframe id="latusHardFrame"
            src="https://docs.google.com/document/d/1UrV2RrEJwLZJ8X5t88GXRuxKbbxp9vq6W2Qeu1nqzV0/preview"
            title="Latus Hard Doc" allowfullscreen style="border:0;"></iframe>
  </div>
  <small class="text-muted d-block mt-2">
    è‹¥æœªé¡¯ç¤ºï¼Œè«‹ç¢ºèª Google æ–‡ä»¶å·²ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€æˆ–æ¬Šé™è¨­å®šå…è¨±å…§åµŒã€‚
  </small>
</div>

<div id="pane-zakum" class="tab-pane d-none">
  <h4 class="card-title mb-2">ğŸ—¿ æ®˜æš´ç‚é­”æ”»ç•¥ï¼ˆZakum Guideï¼‰</h4>
  <div class="ratio ratio-16x9">
    <iframe id="zakumFrame"
            src="https://docs.google.com/document/d/19iRUhl0Es049i5dgVkJlBAuDK3icESjuEqmAGj44cHs/preview"
            title="Zakum Doc" allowfullscreen style="border:0;"></iframe>
  </div>
  <small class="text-muted d-block mt-2">
    è‹¥æœªé¡¯ç¤ºï¼Œè«‹ç¢ºèª Google æ–‡ä»¶å·²ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ã€æˆ–æ¬Šé™è¨­å®šå…è¨±å…§åµŒã€‚
  </small>
</div>
      </div>
    
    </div>
    
  </div>

<script>
// æ”¾åœ¨å…¨åŸŸï¼ˆæˆ– $(function(){ ... }) è£¡é¢æœ€ä¸Šé¢ä¸€é»ï¼‰
// ====== ä¿®æ­£ 1ï¼šå»ºç«‹å–®ä¸€ Modal å¯¦ä¾‹ ======
function getJobModal() {
  const el = document.getElementById('jobStatsModal');
  // getOrCreateInstance æœƒåœ¨æ²’æœ‰å¯¦ä¾‹æ™‚è‡ªå‹• newï¼Œä¸€å®šè¦ç­‰åˆ° el å­˜åœ¨æ™‚æ‰å‘¼å«
  return bootstrap.Modal.getOrCreateInstance(el, { backdrop: true, keyboard: true });
}

// é–‹å•ŸæŒ‰éˆ•ï¼šåªå‘¼å« show()ï¼Œä¸è¦æ¯æ¬¡ new
$(document).on('click', '#btnJobStats', function () {
  if (!Array.isArray(lastData) || lastData.length === 0) {
    alert('å°šæœªè®€å–åˆ°è³‡æ–™ï¼Œè«‹å…ˆç­‰å¾…åˆ—è¡¨è¼‰å…¥æˆ–é»æ“Šé‡æ–°æ•´ç†å¾Œå†è©¦ã€‚');
    return;
  }
  getJobModal().show();
  setTimeout(renderJobChart, 150);
});

// ====== ä¿®æ­£ 2ï¼šé—œé–‰æ™‚ä¸æ‰‹å‹•æ¸…ç† backdrop/bodyï¼ˆäº¤ç”± Bootstrapï¼‰ ======
$(document).on('hidden.bs.modal', '#jobStatsModal', function () {
  const box = document.getElementById('jobHitList');
  if (box) box.innerHTML = 'ï¼ˆé»ä¸€ä¸‹å·¦é‚Šçš„çµ±è¨ˆåœ–åˆ‡ç‰‡ï¼Œé€™è£¡æœƒåˆ—å‡ºè§’è‰²åç¨±ï¼‰';
});

/* =========================
   æ­·å²è§’è‰²æ›´åï¼šè®€å– + é¡¯ç¤º
========================= */
// ä½ çš„ LOG è¡¨ï¼šåŒä¸€ä»½ Sheetï¼Œæ”¹ gid å³å¯
const RENAME_LOG_GID = '170886432';

// å¿«å–ï¼ˆä¾ä»£ç¢¼ã€ä¾æ–°åï¼‰
let renameLogByCode = new Map();
let renameLogByName = new Map();

/** è®€å–æ›´å LOGï¼ˆCSVï¼‰ */
function loadRenameLog(sheetId) {
  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${RENAME_LOG_GID}`;
  Papa.parse(csvUrl, {
    download: true,
    skipEmptyLines: true,
    complete: (res) => {
      try {
        if (!res.data || res.data.length < 2) return;

        // å˜—è©¦å¾è¡¨é ­åˆ¤æ–·æ¬„ä½ï¼ˆç›¡é‡å®¹éŒ¯ï¼‰
        const header = res.data[0].map(h => String(h || '').trim());
        const idx = {
          time: header.findIndex(h => /^(æ™‚é–“|timestamp|time)$/i.test(h)),
          code: header.findIndex(h => /^(è§’è‰²ä»£ç¢¼|ä»£ç¢¼|code)$/i.test(h)),
          old : header.findIndex(h => /^(èˆŠå|old.*name)$/i.test(h)),
          name: header.findIndex(h => /^(æ–°å|åç¨±|name|new.*name)$/i.test(h))
        };

        // è‹¥æ²’åµæ¸¬åˆ°è¡¨é ­ï¼Œå°±ç”¨é è¨­ä½ç½®ï¼ˆ0:æ™‚é–“ 1:èˆŠå 2:æ–°å 3:ä»£ç¢¼ï¼‰å¯æŒ‰ç…§ä½ è¡¨çš„å¯¦éš›é †åºèª¿æ•´
        const safe = (arr, i) => (i >= 0 ? arr[i] : '');
        renameLogByCode.clear();
        renameLogByName.clear();

        for (let i = 1; i < res.data.length; i++) {
          const r = res.data[i];
          const rec = {
            time: safe(r, idx.time) || safe(r, 0),
            old : safe(r, idx.old)  || safe(r, 1),
            name: safe(r, idx.name) || safe(r, 2),
            code: String(safe(r, idx.code) || safe(r, 3) || '').trim()
          };

          // ä¾ä»£ç¢¼å»ºç´¢å¼•
          if (rec.code) {
            if (!renameLogByCode.has(rec.code)) renameLogByCode.set(rec.code, []);
            renameLogByCode.get(rec.code).push(rec);
          }
          // ä¹Ÿç”¨ã€Œæ–°åã€å»ºä¸€ä»½ï¼ˆé¿å…ä»£ç¢¼ç¼ºæ¼æ™‚ä¹Ÿèƒ½æŸ¥ï¼‰
          if (rec.name) {
            if (!renameLogByName.has(rec.name)) renameLogByName.set(rec.name, []);
            renameLogByName.get(rec.name).push(rec);
          }
        }

        // ä¾æ™‚é–“å­—ä¸²åšç²—ç•¥æ’åºï¼ˆæ–°â†’èˆŠï¼‰ï¼›è‹¥ä¸æ˜¯å¯è§£ææ—¥æœŸä¹Ÿæ²’é—œä¿‚
        const sorter = (a, b) => String(b.time).localeCompare(String(a.time));
        [...renameLogByCode.values()].forEach(arr => arr.sort(sorter));
        [...renameLogByName.values()].forEach(arr => arr.sort(sorter));
      } catch (e) {
        console.error('è§£ææ›´å LOG å¤±æ•—', e);
      }
    },
    error: (err) => console.error('è®€å–æ›´å LOG å¤±æ•—', err)
  });
}
/* =========================
   æœå°‹ï¼šåŒæ™‚æ¯”å°æ¸…å–®èˆ‡æ›´å LOG
========================= */

// â˜… è£œå……ï¼šä¹Ÿä»¥ã€ŒèˆŠåã€å»ºä¸€ä»½ç´¢å¼•ï¼Œè®“èˆŠåèƒ½è¢«æœå°‹åˆ°
let renameLogByOldName = new Map();

// â¬‡ï¸ æŠŠé€™æ®µã€Œè£œå»ºèˆŠåç´¢å¼•ã€åŠ åˆ°ä½ ç¾æœ‰çš„ loadRenameLog(...) å…§éƒ¨ã€for è¿´åœˆ push å®Œä¹‹å¾Œ
// ----ï¼ˆèªªæ˜ï¼šè‹¥ä½ ä¸æƒ³æ”¹ loadRenameLogï¼Œæœ¬æ®µä¹Ÿå¯åœ¨å®ƒ complete çµæŸå¾Œå¦å¤–è·‘ä¸€é mapï¼Œä½†ç›´æ¥å¯«åœ¨åŸå‡½å¼æœ€çœäº‹ï¼‰----
//   if (rec.old) {
//     if (!renameLogByOldName.has(rec.old)) renameLogByOldName.set(rec.old, []);
//     renameLogByOldName.get(rec.old).push(rec);
//   }
//   // å®Œæ•´åº¦ï¼šè®“èˆŠå/æ–°å map éƒ½ä¾æ™‚é–“æ–°â†’èˆŠæ’åºï¼ˆä¿éšªï¼‰
/*
const sorter = (a, b) => String(b.time).localeCompare(String(a.time));
[...renameLogByOldName.values()].forEach(arr => arr.sort(sorter));
*/

//
// è‹¥ä½ ä¸æ–¹ä¾¿å›é ­æ”¹ loadRenameLogï¼Œå¯ä»¥åœ¨é€™è£¡åšä¸€æ¬¡åŒæ­¥ï¼ˆä¿éšªå¯«æ³•ï¼‰ï¼š
function rebuildOldNameIndexFromCaches() {
  renameLogByOldName = new Map();
  if (renameLogByCode.size === 0 && renameLogByName.size === 0) return;
  // ç”± code cache é‡å»ºï¼ˆæœ€å®Œæ•´ï¼‰
  for (const arr of renameLogByCode.values()) {
    for (const rec of arr) {
      const old = (rec?.old || '').trim();
      if (!old) continue;
      if (!renameLogByOldName.has(old)) renameLogByOldName.set(old, []);
      renameLogByOldName.get(old).push(rec);
    }
  }
  const sorter = (a, b) => String(b.time).localeCompare(String(a.time));
  [...renameLogByOldName.values()].forEach(a => a.sort(sorter));
}

// â˜… å·¥å…·ï¼šå¤§å°å¯«ä¸æ•æ„Ÿ + å»ç©ºç™½ çš„ã€ŒåŒ…å«ã€åˆ¤æ–·
function includesLike(haystack, needle) {
  if (!needle) return false;
  const a = String(haystack || '').toLowerCase().trim();
  const b = String(needle || '').toLowerCase().trim();
  return a.includes(b);
}

// å›å‚³ï¼šç¬¦åˆæ¢ä»¶çš„ã€Œè§’è‰²ä»£ç¢¼ã€é›†åˆï¼ˆå¾ç•¶å‰æ¸…å–®åå­— or LOG èˆŠå/æ–°åï¼‰
function findCodesByNameKeyword(keyword) {
  const codes = new Set();

  // 1) ç›´æ¥æƒç•¶å‰æ¸…å–®çš„åå­—
  for (const r of (lastData || [])) {
    if (includesLike(r?.name, keyword)) {
      if (r?.code) codes.add(String(r.code).trim());
    }
  }

  // 2) æƒ LOGï¼šæ–°å
  for (const [newName, arr] of renameLogByName.entries()) {
    if (!includesLike(newName, keyword)) continue;
    arr.forEach(rec => rec?.code && codes.add(String(rec.code).trim()));
  }

  // 3) æƒ LOGï¼šèˆŠå
  for (const [oldName, arr] of renameLogByOldName.entries()) {
    if (!includesLike(oldName, keyword)) continue;
    arr.forEach(rec => rec?.code && codes.add(String(rec.code).trim()));
  }

  return codes;
}

// ä¾ä»£ç¢¼æ‹¿ç•¶å‰æ¸…å–®è³‡æ–™
function getCurrentRowsByCodes(codeSet) {
  const out = [];
  const want = new Set(Array.from(codeSet).map(c => String(c).trim()));
  for (const r of (lastData || [])) {
    const c = String(r?.code || '').trim();
    if (c && want.has(c)) out.push(r);
  }
  return out;
}

// å–æŸä»£ç¢¼çš„å®Œæ•´æ›´åç´€éŒ„ï¼ˆæ–°â†’èˆŠï¼‰
function getSortedLogByCode(code) {
  const arr = renameLogByCode.get(String(code).trim()) || [];
  // é€™è£¡çš„æ’åºåœ¨ loadRenameLog å·²åšï¼›å†ä¿éšªä¸€æ¬¡
  return [...arr].sort((a,b)=> String(b.time).localeCompare(String(a.time)));
}

// æ¸²æŸ“æœå°‹çµæœ
function renderSearchResults(keyword, rows, codeSet) {
  // Echo é—œéµå­—
  $('#searchQueryEcho').text(`é—œéµå­—ï¼š${keyword || 'ï¼ˆç©ºï¼‰'}`);

  const tbody = $('#searchResultBody');
  if (!rows || rows.length === 0) {
    tbody.html(`<tr><td colspan="7" class="text-center text-muted">ç„¡ç¬¦åˆé …ç›®</td></tr>`);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('searchResultModal')).show();
    return;
  }

  const html = rows.map(r => {
    const logs = getSortedLogByCode(r.code);
    // å°‡æ›´åç´€éŒ„åšæˆå°åˆ—è¡¨
    const logHtml = logs.length
      ? logs.map(x => `
          <div class="small">
            <span class="badge text-bg-secondary">${x.time || ''}</span>
            ${x.old ? `ã€Œ${x.old}ã€â†’` : ''}ã€Œ${x.name || ''}ã€
          </div>
        `).join('')
      : `<span class="text-muted small">ï¼ˆç„¡ç´€éŒ„ï¼‰</span>`;

    return `
      <tr>
        <td>${r.name ?? ''}</td>
        <td>${r.code ?? ''}</td>
        <td>${r.job ?? ''}</td>
        <td>${r.level ?? ''}</td>
        <td>${r.attack ?? ''}</td>
        <td>${r.camp ?? ''}</td>
        <td>
		  ${logHtml}
		  <div class="mt-1">
		    <button type="button"
		  	  class="btn btn-sm btn-outline-primary btn-locate-row"
			  data-code="${r.code ?? ''}"
		  	  data-camp="${r.camp ?? ''}">
		  	  ğŸ” å®šä½æ­¤åˆ—
		    </button>
		  </div>
		</td>
      </tr>
    `;
  }).join('');

  tbody.html(html);
  bootstrap.Modal.getOrCreateInstance(document.getElementById('searchResultModal')).show();
}

// ç¶å®šæœå°‹æ¡†ï¼ˆæŒ‰éˆ• + Enterï¼‰
function doCharacterSearch() {
  const kw = $('#charSearchInput').val().trim();
  if (!kw) {
    // ç©ºå­—ä¸²ï¼šç›´æ¥æç¤º
    $('#searchQueryEcho').text('é—œéµå­—ï¼šï¼ˆç©ºï¼‰');
    $('#searchResultBody').html(`<tr><td colspan="7" class="text-center text-muted">è«‹è¼¸å…¥é—œéµå­—</td></tr>`);
    bootstrap.Modal.getOrCreateInstance(document.getElementById('searchResultModal')).show();
    return;
  }

  // ç¢ºä¿èˆŠåç´¢å¼•å­˜åœ¨
  if (!renameLogByOldName || renameLogByOldName.size === 0) {
    rebuildOldNameIndexFromCaches();
  }

  const codes = findCodesByNameKeyword(kw);
  const rows  = getCurrentRowsByCodes(codes);

  renderSearchResults(kw, rows, codes);
}

// äº‹ä»¶ç¶å®šï¼ˆæ”¾åœ¨ $(function(){ ... }) å…§æˆ–å¤–çš†å¯ï¼›è‹¥æ”¾å¤–å±¤å»ºè­°ä¿éšªç”¨å§”æ´¾ï¼‰ï¼š
$(document).on('click', '#charSearchBtn', doCharacterSearch);
$(document).on('keypress', '#charSearchInput', function(e){
  if (e.which === 13) doCharacterSearch();
});

/** å–å¾—æŸè§’è‰²çš„æ›´åç´€éŒ„ï¼ˆå„ªå…ˆç”¨ä»£ç¢¼åŒ¹é…ï¼Œå¦å‰‡ç”¨ç›®å‰åç¨±ï¼‰ */
function getRenameHistory(name, code) {
  const byCode = (code && renameLogByCode.get(String(code).trim())) || [];
  if (byCode.length) return byCode;
  return (name && renameLogByName.get(String(name).trim())) || [];
}

/** é–‹å•Ÿ Modal ä¸¦æ¸²æŸ“æ¸…å–® */
function openRenameLogModal(name, code) {
  const list = getRenameHistory(name, code);
  const box  = document.getElementById('renameLogList');
  const who  = document.getElementById('renameLogTarget');

  who.textContent = `æŸ¥è©¢è§’è‰²ï¼š${name || '(æœªå¡«)'}${code ? `ï¼ˆä»£ç¢¼ï¼š${code}ï¼‰` : ''}`;

  if (!list.length) {
    box.innerHTML = `<div class="text-muted">æ­¤è§’è‰²ç›®å‰æ²’æœ‰æ›´åç´€éŒ„ã€‚</div>`;
  } else {
    // é¡¯ç¤ºæˆç°¡å–®æ™‚é–“è»¸
    const html = list.map(x => `
      <div class="d-flex align-items-start gap-2 py-1">
        <span class="badge text-bg-secondary">${x.time || ''}</span>
        <div>
          <div><b>${x.name || ''}</b></div>
          ${x.old ? `<div class="small text-muted">ç”±ã€Œ${x.old}ã€æ›´åç‚ºã€Œ${x.name}ã€</div>` : ''}
          ${x.code ? `<div class="small text-muted">è§’è‰²ä»£ç¢¼ï¼š${x.code}</div>` : ''}
        </div>
      </div>
      <hr class="my-1">
    `).join('');
    box.innerHTML = html;
  }

  bootstrap.Modal.getOrCreateInstance(document.getElementById('renameLogModal')).show();
}

// ç¶å®šï¼šé»å•è™Ÿé–‹å•Ÿ Modalï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
$(document).on('click', '.name-history-btn', function () {
  const name = $(this).data('name') || '';
  const code = $(this).data('code') || '';
  openRenameLogModal(name, code);
});


// æ®˜æš´ç‚é­”æ”»ç•¥ï¼šGoogle æ–‡ä»¶åµŒå…¥ç¶²å€ï¼ˆå»ºè­°ç”¨ç™¼ä½ˆåˆ°ç¶²è·¯å¾Œçš„ /pub?embedded=trueï¼‰
//const ZAKUM_DOC_EMBED = "https://docs.google.com/document/d/19iRUhl0Es049i5dgVkJlBAuDK3icESjuEqmAGj44cHs/pub?embedded=true";
// è‹¥æœªç™¼ä½ˆã€ä½†åˆ†äº«æ¬Šé™é–‹æ”¾ï¼Œä¹Ÿå¯æš«ç”¨ previewï¼ˆå¯èƒ½æœƒè¢« X-Frame-Options æ“‹ï¼‰
 const ZAKUM_DOC_EMBED = "https://docs.google.com/document/d/19iRUhl0Es049i5dgVkJlBAuDK3icESjuEqmAGj44cHs/preview";

/* =========================
   è¨­å®šï¼šè«‹å¡«ä½ çš„ Apps Script Web Appï¼ˆexecï¼‰URL
========================= */
const GAS_UPDATE_URL = //'https://script.google.com/macros/s/AKfycbwbEW15caNLWOUqm8VKby2tN_JfCySTT6xFtreuFz9K0Ex51qioyeqNi476jVH4vlGo/exec';
'https://script.google.com/macros/s/AKfycbwAAMocuEMv_Q1xbEqP7yykZ61Wvo-8v_aMDvzyDjrxHtBFtS2MDYr1rTXZfRUaAfL8/exec';
// æŠŠã€Œæ–°å¢è§’è‰²ã€äº‹ä»¶è¨˜éŒ„åˆ° æ­·å²æ›´åLOGï¼ˆgid=170886432ï¼‰
async function appendRenameLogToGAS({ code, name, when }) {
  if (!code || !name) throw new Error('appendRenameLog éœ€è¦ code èˆ‡ name');
  const form = new URLSearchParams();
  form.set('action', 'appendRenameLog');   // å¾Œç«¯æœƒç”¨é€™å€‹åˆ†æµ
  form.set('code',   String(code).trim());
  form.set('name',   String(name).trim());
  // é€æœ¬åœ°æ™‚é–“çš„ ISO å­—ä¸²ï¼ˆå¾Œç«¯æœƒå†ä¾å°åŒ—æ™‚å€æ ¼å¼åŒ–ï¼‰
  form.set('when',   when || new Date().toISOString());

  const resp = await fetch(GAS_UPDATE_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: form.toString(),
    cache: 'no-store',
    redirect: 'follow'
  });
  const text = await resp.text();
  let json; try { json = JSON.parse(text); } catch(e) { throw new Error('GAS å›å‚³é JSON'); }
  if (!resp.ok || json.status !== 'ok') throw new Error(json.message || 'appendRenameLog å¤±æ•—');
  return json;
}

/* =========================
   å¤œé–“æ¨¡å¼åˆ‡æ›
========================= */
$('#toggleTheme').on('click', function () 
{
  const html = document.documentElement;
  const isDark = html.getAttribute('data-bs-theme') === 'dark';
  html.setAttribute('data-bs-theme', isDark ? 'light' : 'dark');
  $(this).text(isDark ? 'ğŸŒ™ å¤œé–“æ¨¡å¼' : 'â˜€ï¸ æ—¥é–“æ¨¡å¼');
});


/* ==== è¿”å›è§’è‰²æ¸…å–®ï¼šæ“´å……æ—¢æœ‰è™•ç†ï¼Œè®“å…©å€‹æ”»ç•¥é éƒ½èƒ½è¿”å› ==== */
// å°‡ä½ åŸæœ¬çš„ backToList äº‹ä»¶ã€Œæ›¿æ›ã€æˆä¸‹é¢é€™æ®µï¼ˆæˆ–ç›´æ¥è¦†å¯«ï¼‰
$(document).off('click', '#backToList').on('click', '#backToList', function () 
{
  $('#GuidePage').addClass('d-none');     // éš±è—æ¸…å–®
  $('#homePage').removeClass('d-none');
});

$('#Guide').on('click', function () 
{
  $('#homePage').addClass('d-none');       // éš±è—æ¸…å–®
  $('#GuidePage').removeClass('d-none');   // é¡¯ç¤ºæ”»ç•¥
});

/* =========================
   æ®˜æš´ç‚é­”æ”»ç•¥ï¼šå–®é åˆ‡æ›
========================= */
//ï¼ˆä¿ç•™ä½ çš„è¨»è§£èˆ‡æœªä½¿ç”¨çš„ç¨‹å¼ç¢¼ï¼‰

/* =========================
   å…¬ç”¨ï¼šè§£æ URL åƒæ•¸
========================= */
function getQueryParams() 
{
  const params = new URLSearchParams(window.location.search);
  return Object.fromEntries(params.entries());
}
function parseSheetFromUrl(url) 
{
  if (!url) return null;
  const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
  if (!idMatch) return null;
  const sheetId = idMatch[1];
  const urlObj = new URL(url);
  const gid = urlObj.searchParams.get('gid') || (url.includes('#gid=') ? url.split('#gid=')[1] : '0');
  return { sheetId, gid };
}

/* =========================
   å…¨åŸŸç‹€æ…‹ï¼ˆâ˜… æ–°å¢ï¼‰
========================= */
let currentTab = 'latus';   // 'latus' | 'latushard' | 'zakum' | 'trainext'
let lastData   = [];        // è®€å–å¾Œä¿å­˜ï¼Œåˆ‡åˆ†é æ™‚é‡ç¹ªä½¿ç”¨
let lastData_OneP   = [];        // è®€å–å¾Œä¿å­˜ï¼Œåˆ‡åˆ†é æ™‚é‡ç¹ªä½¿ç”¨

/* =========================
   è®€å– Google Sheetï¼ˆä»¥ CSV åŒ¯å‡ºï¼‰
========================= */
function loadFromSheet(sheetId, gid = '0') 
{
  $('#msg').text('');
  $('#tableBody').html(`
    <tr>
    <td colspan="7" class="text-center text-muted">è®€å–ä¸­...</td>
    </tr>
  `);
  
  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
  
  Papa.parse(csvUrl, {
    download: true,
    skipEmptyLines: true,
    complete: function (result) {
    try {
      if (!result.data || result.data.length < 2) {
      $('#msg').text('æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º');
      lastData = [];
      renderTable(lastData);
      return;
      }
  
      const rows = result.data.slice(1);
      lastData = rows
      .map((r, i) => ({
        name:  r[1], // B
        code:  r[2], // Cï¼ˆä¸»éµï¼‰
        job:   r[3], // D
        level: r[4], // E
        attack:r[6], // F ä¹¾è¡¨
        camp:  r[9], // G ç‡Ÿå€
        rowIndex: i + 2
      }))
      .filter(r => r && r.name);
  
      renderTable(lastData);
    } catch (e) {
      console.error(e);
      $('#msg').text('è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
      lastData = [];
      renderTable(lastData);
    }
    },
    error: function (err) {
    console.error(err);
    $('#msg').text('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè©² Google Sheet å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ã€‚');
    lastData = [];
    renderTable(lastData);
    }
  });
}

/* =========================
   ä¾åˆ†é éæ¿¾ + åˆ†çµ„é¡¯ç¤ºï¼ˆâ˜… èª¿æ•´ï¼‰
========================= */
function renderTable(data) 
{
  // ä¾ç›®å‰åˆ†é éæ¿¾ç‡Ÿå€
  const zhNums = 'ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å';
  const reLatus = new RegExp(`^æ™®æ‹‰[${zhNums}]ç‡Ÿ$`);
  const reLatushard = new RegExp(`^å›°æ‹‰[${zhNums}]ç‡Ÿ$`);
  const reZakum = new RegExp(`^ç‚é­”[${zhNums}]ç‡Ÿ$`);
  
  const groupNotes = 
  {
    'æ™®æ‹‰ä¸€ç‡Ÿ': 'ğŸ”°æ­çš‡æŒ‡å®šå¸­ğŸ—ï¸',
    'æ™®æ‹‰äºŒç‡Ÿ': 'ğŸ”°ç‘æ°£åƒæ¢åœ˜ğŸ’',
    'æ™®æ‹‰ä¸‰ç‡Ÿ': 'ğŸ”°é¦¬åˆ°æˆåŠŸåœ˜ğŸ',
    'æ™®æ‹‰å››ç‡Ÿ': 'ğŸ”°å‚³å¥‡ç©ºæ®¼åœ˜ğŸ¥¥',
    'æ™®æ‹‰äº”ç‡Ÿ': 'ğŸ”°ç¥–å®—ä¿ä½‘æˆ‘â›©ï¸',
    'æ™®æ‹‰å…­ç‡Ÿ': 'ğŸ”°æ‹‰åœ–å¨›æ¨‚åŸğŸ°',
    'æ™®æ‹‰ä¸ƒç‡Ÿ': 'ğŸ”°éæ´²ç•¢æ¥­ç­ğŸ—¿',
  };
  
  const filtered = (data || []).filter(r => 
  {
    const camp = (r.camp || '').trim();
    if (currentTab === 'latus')   return reLatus.test(camp);
    if (currentTab === 'latushard')  return reLatushard.test(camp);
    if (currentTab === 'zakum')   return reZakum.test(camp);
    if (currentTab === 'trainext')return (camp === 'è¨“ç·´ç‡Ÿ' || camp === 'å¤–æ´å¤§å¤§');
    return true;
  });
  
  if (!filtered.length) 
  {
    $('#tableBody').html(`
    <tr>
      <td colspan="7" class="text-center text-muted">æ­¤åˆ†é ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td>
    </tr>
    `);
    return;
  }
  
  // ä¾ç‡Ÿå€åˆ†çµ„
  const groups = {};
  for (const r of filtered) 
  {
    const key = (r.camp || 'æœªå¡«å¯«').toString().trim();
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  }
  
  // ä¾ã€Œä¸€äºŒä¸‰â€¦åã€æ’åº
  const mapCN = { 'é›¶':0,'ã€‡':0,'ä¸€':1,'äºŒ':2,'å…©':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10 };
  function chineseNumToInt(txt) 
  {
    if (!txt) return NaN;
    const m = txt.match(/[é›¶ã€‡ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]/g);
    if (!m) return NaN;
    const s = m.join('');
    if (s === 'å') return 10;
    const tenIdx = s.indexOf('å');
    if (tenIdx === -1) return mapCN[s] ?? NaN;
    const left = tenIdx === 0 ? 1 : (mapCN[s[0]] ?? 0);
    const right = tenIdx === s.length - 1 ? 0 : (mapCN[s[tenIdx+1]] ?? 0);
    return left * 10 + right;
  }
  
  const orderedKeys = Object.keys(groups).sort((a,b) => {
    const na = chineseNumToInt(a);
    const nb = chineseNumToInt(b);
    if (!isNaN(na) && !isNaN(nb)) return na - nb;
    return a.localeCompare(b, 'zh-Hant');
  });
  
  let html = '';
  for (const k of orderedKeys) {
    const note = groupNotes[k] ? `ã€€${groupNotes[k]}` : ''; // æœ‰å°ç…§å°±åŠ ï¼Œæ²’æœ‰å°±ç©ºå­—ä¸²
    html += `
    <tr class="group-row">
      <td colspan="7">æ‰€åœ¨ç‡Ÿå€ï¼š${k}${note}ï¼ˆ${groups[k].length}ï¼‰</td>
    </tr>`;
    html += groups[k].map(r => `
    <tr id="row-${(r.code||'').toString().trim().replace(/[^a-zA-Z0-9_-]/g,'_')}">
      <td>${r.name ?? ''}</td>
	  <td>
		<div class="d-inline-flex align-items-center" style="gap:.5rem;">
		  <button type="button"
		    class="name-history-btn"
		    title="æŸ¥çœ‹æ›´åç´€éŒ„"
		    data-name="${r.name ?? ''}"
		    data-code="${r.code ?? ''}">?</button>
	      <span class="font-monospace">${r.code ?? ''}</span>
	    </div>
	  </td>
      <td>${r.job ?? ''}</td>
      <td>${r.level ?? ''}</td>
      <td>${r.attack ?? ''}</td>
      <td>${r.camp ?? ''}</td>
      <td>
      <button class="btn btn-outline-secondary btn-edit"
        data-row="${r.rowIndex || ''}"
        data-name="${r.name ?? ''}"
        data-code="${r.code ?? ''}"
        data-job="${r.job ?? ''}"
        data-level="${r.level ?? ''}"
        data-attack="${r.attack ?? ''}"
        data-camp="${r.camp ?? ''}">ä¿®æ”¹</button>
      </td>
    </tr>`).join('');
  }
  
  $('#tableBody').html(html);
  
  // ç¶å®šã€Œä¿®æ”¹ã€
  $('#tableBody').off('click', '.btn-edit').on('click', '.btn-edit', function(){
    const $btn = $(this);
    openEditor({
    name:  $btn.data('name'),
    code:  $btn.data('code'),
    job:   $btn.data('job'),
    level: $btn.data('level'),
    attack:$btn.data('attack'),
    camp:  $btn.data('camp'),
    rowIndex: Number($btn.data('row') || 0)
    }, (updated) => {
    // æ›´æ–°å‰ç«¯ç•¶åˆ—
    const tr = $btn.closest('tr')[0];
    const tds = tr.querySelectorAll('td');
    tds[0].textContent = updated.name;
    tds[1].textContent = updated.code;
    tds[2].textContent = updated.job;
    tds[3].textContent = updated.level;
    tds[4].textContent = updated.attack;
    tds[5].textContent = updated.camp;
  
    $btn.data('name',  updated.name);
    $btn.data('code',  updated.code);
    $btn.data('job',   updated.job);
    $btn.data('level', updated.level);
    $btn.data('attack',updated.attack);
    $btn.data('camp',  updated.camp);
    });
  });
}

/* =========================
   åˆ†é åˆ‡æ›ï¼ˆâ˜… æ–°å¢ï¼‰
========================= */
function setTab(tab) 
{
  currentTab = tab; // 'latus' | 'zakum' | 'trainext'
  // åˆ‡æ›æ¨£å¼
  $('#tabLatus').toggleClass('active', tab === 'latus');
  $('#tabLatusHard').toggleClass('active', tab === 'latushard');
  $('#tabZakumList').toggleClass('active', tab === 'zakum');
  $('#tabTrainExt').toggleClass('active', tab === 'trainext');
  // ä¾ç›®å‰åˆ†é é‡ç¹ª
  renderTable(lastData);
}

  $('#tabLatus').on('click',     () => setTab('latus'));
  $('#tabLatusHard').on('click', () => setTab('latushard'));
  $('#tabZakumList').on('click', () => setTab('zakum'));
  $('#tabTrainExt').on('click',  () => setTab('trainext'));


function loadFromSheet_OneP(sheetId, gid = '0', searchWord = "") 
{
  $('#msg').text('');
  $('#tableBody').html(`
    <tr>
    <td colspan="4" class="text-center text-muted">è®€å–ä¸­...</td>
    </tr>
  `);
  
  const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
  
  Papa.parse(csvUrl, {
    download: true,
    skipEmptyLines: true,
    complete: function (result) {
    try {
      if (!result.data || result.data.length < 2) 
      {
        $('#msg').text('æ²’æœ‰è³‡æ–™å¯é¡¯ç¤º');
        lastData_OneP = [];
        renderTable_OneP(lastData_OneP);
        return;
      }
  
      const rows = result.data.slice(1);
      lastData_OneP = rows
      .map((r, i) => ({
        category:   r[0], // A
        name:     r[1], // B
        keyword:  r[2], // C
        link:     r[3], // D
        rowIndex:   i + 2
      }))
      .filter(r => r && r.name);
  
      renderTable_OneP(lastData_OneP);
    } 
    catch (e) 
    {
      console.error(e);
      $('#msg').text('è§£æè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤');
      lastData_OneP = [];
      renderTable_OneP(lastData_OneP);
    }
    },
    error: function (err) 
    {
      console.error(err);
      $('#msg').text('è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè©² Google Sheet å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººå¯æª¢è¦–ã€ã€‚');
      lastData_OneP = [];
      renderTable_OneP(lastData_OneP);
    }
  });
}



function renderTable_OneP(data, searchWord = "") 
{
  const groupNotes = 
  {
    'éŠæˆ²çŸ¥è­˜': '',
    'BOOæ”»ç•¥': '',
  };
  
  const filtered = data;  
  // ...ï¼ˆä½ åŸæœ¬ renderTable å¾ŒçºŒçš„åˆ†çµ„/æ’åº/è¼¸å‡ºä¿æŒä¸è®Šï¼‰
  
  if (!filtered.length) 
  {
    $('#tableBody_OneP').html(`
    <tr>
      <td colspan="4" class="text-center text-muted">æ­¤åˆ†é ä¸‹æ²’æœ‰ç¬¦åˆçš„è³‡æ–™</td>
    </tr>
    `);
    return;
  }
  
  // åˆ†é¡åˆ†çµ„
  const groups = {};
  for (const r of filtered) 
  {
    const key = (r.category || 'æœªå¡«å¯«').toString().trim();
    if (!groups[key]) groups[key] = [];
    groups[key].push(r);
  }
  
  const orderedKeys = Object.keys(groups);
  
  let html = '';
  for (const k of orderedKeys) 
  {
    const note = groupNotes[k] ? `ã€€${groupNotes[k]}` : ''; // æœ‰å°ç…§å°±åŠ ï¼Œæ²’æœ‰å°±ç©ºå­—ä¸²
    if (searchWord == "")
    {
      html += `
      <tr class="group-row">
        <td colspan="4">ä¸€åœ–æµåˆ†é¡ï¼š${k}${note}ï¼ˆ${groups[k].length}ï¼‰</td>
      </tr>`;
      
      html += groups[k].map(r => `
      <tr>
        <td>${r.category ?? ''}</td>
        <td>${r.name ?? ''}</td>
        <td>${r.keyword ?? ''}</td>
        <td>
        ${r.link ? `
        <a href="https://drive.google.com/file/d/${r.link}/" target="_blank">
        <img src="https://lh3.googleusercontent.com/d/${r.link}=h800?authuser=0" alt=${r.name} title=${r.name} height="200px;">
        </a>
        ` : 'ç„¡åœ–ç‰‡'}
        </td>
      </tr>`).join('');
    }
    else
    {
      for (const p of groups[k]) 
      {
        if (p.category.indexOf(searchWord) != -1 || p.name.indexOf(searchWord) != -1 || p.keyword.indexOf(searchWord) != -1)
        {
          html += `
          <tr>
            <td>${p.category ?? ''}</td>
            <td>${p.name ?? ''}</td>
            <td>${p.keyword ?? ''}</td>
            <td>
            ${p.link ? `
            <a href="https://drive.google.com/file/d/${p.link}/" target="_blank">
            <img src="https://lh3.googleusercontent.com/d/${p.link}=h800?authuser=0" alt=${p.name} title=${p.name} height="200px;">
            </a>
            ` : 'ç„¡åœ–ç‰‡'}
            </td>
          </tr>`;  
        }
      }
    }
  }
  
  $('#tableBody_OneP').html(html);

}



/* =========================
   å•Ÿå‹•æµç¨‹ï¼šè‡ªå‹•è®€å–
========================= */
const DEFAULT_SHEET_URL = 'https://docs.google.com/spreadsheets/d/1-j04395CPwDlZnJ2vUt3k4wsT5rPHgQWmujSQCi76Fs/edit?gid=0#gid=0';
const OnePicture_URL = 'https://docs.google.com/spreadsheets/d/1ZFHkpsHKc0LWQDNPrP8Y5NS27aee0mOniK2uB8C2zD4/edit?gid=0#gid=0';
function resolveSheetTarget(resolveURL) 
{
  const qp = getQueryParams();
  if (qp.sheetUrl) {
    const parsed = parseSheetFromUrl(qp.sheetUrl);
    if (parsed) return parsed;
  }
  if (qp.sheetId) {
    return { sheetId: qp.sheetId, gid: qp.gid || '0' };
  }
  const parsedDefault = parseSheetFromUrl(resolveURL);
  return parsedDefault || { sheetId: '', gid: '0' };
}
function updateSourceBadge(sheetId, gid) 
{
  if (!sheetId) return;
  const badge = $('#sourceBadge');
  badge.text(`sheetId=${sheetId} | gid=${gid}`);
  badge.removeClass('d-none');
}

$(function () 
{
  // è¼‰å…¥å°å¤¥ä¼´æ¸…å–®
  const target = resolveSheetTarget(DEFAULT_SHEET_URL);
  if (!target.sheetId) {
    $('#msg').text('ç„¡æ³•è§£ææŒ‡å®šçš„ Google Sheet é€£çµæˆ– sheetId');
    return;
  }
  updateSourceBadge(target.sheetId, target.gid);
  loadFromSheet(target.sheetId, target.gid);
  loadRenameLog(target.sheetId); 	// â˜… æ–°å¢ï¼šåŒæ™‚æŠŠæ›´å LOG è®€é€²ä¾†ï¼ˆgid=170886432ï¼‰
  
  // Event å°å¤¥ä¼´æ¸…å–®ï¼šé‡æ–°æ•´ç†
  $('#reloadBtn').on('click', function () 
  {
    loadFromSheet(target.sheetId, target.gid);
  });
  
  // Event å°å¤¥ä¼´æ¸…å–®ï¼šæ–°å¢è§’è‰²
  $('#addBtn').on('click', function () 
  {
    openEditor({
    name: '', code: '', job: '', level: '', attack: '', camp: '',
    rowIndex: 0, __isNew: true
    }, () => { alert('å·²æ–°å¢'); });
  });
  
  
  // è¼‰å…¥å”å”ä¸€åœ–æµ
  const target_OneP = resolveSheetTarget(OnePicture_URL);
  if (!target_OneP.sheetId) {
    $('#msg').text('ç„¡æ³•è§£ææŒ‡å®šçš„ Google Sheet é€£çµæˆ– sheetId');
    return;
  }
  updateSourceBadge(target_OneP.sheetId, target_OneP.gid);
  loadFromSheet_OneP(target_OneP.sheetId, target_OneP.gid);
  
  // Event å”å”ä¸€åœ–æµï¼šé‡æ–°æ•´ç†
  $('#reloadBtn_OneP').on('click', function () 
  {
    loadFromSheet_OneP(target_OneP.sheetId, target_OneP.gid);
  });
  
  // Event å”å”ä¸€åœ–æµï¼šæœå°‹
  $('#btn_SearchOneP').on('click', function () 
  {
    const m_SearchWord = document.querySelector('input[name="txt_Search"]').value;
    renderTable_OneP(lastData_OneP, m_SearchWord);
  });
  
  $('input[name="txt_Search"]').on('keypress', function (e) 
  {
    if (e.which === 13) 
    { // 13 æ˜¯ Enter éµçš„ä»£ç¢¼
      const m_SearchWord = document.querySelector('input[name="txt_Search"]').value;
      renderTable_OneP(lastData_OneP, m_SearchWord);
    }
  });
  
  // Event å”å”ä¸€åœ–æµï¼šé‡ç½®
  $('#btn_ResetOneP').on('click', function () 
  {
    const m_SearchWord = document.querySelector('input[name="txt_Search"]').value;
    renderTable_OneP(lastData_OneP);
  });
  
}
);

/* =========================
   ç·¨è¼¯è¦–çª—ï¼ˆå«ç‡Ÿå€ä¸‹æ‹‰ï¼‰â€” ä¿ç•™ä½ åŸæœ¬çš„å¯«å› GAS åšæ³•
========================= */
function createEditor() 
{
  const overlay = document.createElement('div');
  overlay.id = 'editOverlay';
  Object.assign(overlay.style, {
    position: 'fixed', inset: 0, background: 'rgba(0,0,0,.4)',
    display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 9999
  });
  
  const card = document.createElement('div');
  Object.assign(card.style, {
    position: 'relative',
    background: '#fff', borderRadius: '12px', padding: '18px', width: 'min(520px, 92vw)',
    boxShadow: '0 10px 30px rgba(0,0,0,.2)', color: '#222', fontFamily: 'system-ui,-apple-system,BlinkMacSystemFont'
  });
  card.innerHTML = `
    <h3 style="margin:0 0 12px;font-size:18px;">ä¿®æ”¹è³‡æ–™</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>è§’è‰²åç¨±ï¼ˆBï¼‰</span>
      <input id="edit_name" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>è§’è‰²ä»£ç¢¼ï¼ˆCï¼‰</span>
      <input id="edit_code" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>è§’è‰²è·æ¥­ï¼ˆDï¼‰</span>
      <input id="edit_job" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>è§’è‰²ç­‰ç´šï¼ˆEï¼‰</span>
      <input id="edit_level" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>è§’è‰²ä¹¾è¡¨ï¼ˆFï¼‰</span>
      <input id="edit_attack" type="text" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;">
      <span>æ‰€åœ¨ç‡Ÿå€ï¼ˆGï¼‰</span>
      <select id="edit_camp" style="padding:8px 10px;border:1px solid #ddd;border-radius:8px;">
      <option value="">ï¼ˆè«‹é¸æ“‡ï¼‰</option>
      <!-- ä¾ä½ å¯¦éš›ä½¿ç”¨çš„ç‡Ÿå€å­—æ¨£ç¶­æŒå³å¯ -->
      <option>æ™®æ‹‰ä¸€ç‡Ÿ</option><option>æ™®æ‹‰äºŒç‡Ÿ</option><option>æ™®æ‹‰ä¸‰ç‡Ÿ</option><option>æ™®æ‹‰å››ç‡Ÿ</option><option>æ™®æ‹‰äº”ç‡Ÿ</option>
      <option>æ™®æ‹‰å…­ç‡Ÿ</option><option>æ™®æ‹‰ä¸ƒç‡Ÿ</option><option>æ™®æ‹‰å…«ç‡Ÿ</option><option>æ™®æ‹‰ä¹ç‡Ÿ</option><option>æ™®æ‹‰åç‡Ÿ</option>
      <option>å›°æ‹‰ä¸€ç‡Ÿ</option><option>å›°æ‹‰äºŒç‡Ÿ</option><option>å›°æ‹‰ä¸‰ç‡Ÿ</option><option>å›°æ‹‰å››ç‡Ÿ</option><option>å›°æ‹‰äº”ç‡Ÿ</option>
      <option>å›°æ‹‰å…­ç‡Ÿ</option><option>å›°æ‹‰ä¸ƒç‡Ÿ</option><option>å›°æ‹‰å…«ç‡Ÿ</option><option>å›°æ‹‰ä¹ç‡Ÿ</option><option>å›°æ‹‰åç‡Ÿ</option>
      <option>ç‚é­”ä¸€ç‡Ÿ</option><option>ç‚é­”äºŒç‡Ÿ</option><option>ç‚é­”ä¸‰ç‡Ÿ</option><option>ç‚é­”å››ç‡Ÿ</option><option>ç‚é­”äº”ç‡Ÿ</option>
      <option>ç‚é­”å…­ç‡Ÿ</option><option>ç‚é­”ä¸ƒç‡Ÿ</option><option>ç‚é­”å…«ç‡Ÿ</option><option>ç‚é­”ä¹ç‡Ÿ</option><option>ç‚é­”åç‡Ÿ</option>
      <option>è¨“ç·´ç‡Ÿ</option><option>å¤–æ´å¤§å¤§</option>
      </select>
    </label>
    </div>
    <div class="d-flex gap-2 justify-content-end mt-3">
    <button id="btn_cancel" class="btn btn-light border">å–æ¶ˆ</button>
    <button id="btn_save" class="btn btn-primary">å„²å­˜</button>
    </div>

    <!-- Loading é®ç½©ï¼ˆé è¨­éš±è—ï¼‰ -->
    <div id="editLoadingMask" style="
      display:none; position:absolute; inset:0; background:rgba(255,255,255,.75);
      border-radius:12px; z-index:10; backdrop-filter:saturate(180%) blur(2px);
      align-items:center; justify-content:center;">
      <div class="text-center">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <div class="mt-2 fw-semibold">è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
      </div>
    </div>
  `;
  overlay.appendChild(card);
  document.body.appendChild(overlay);
  return overlay;
}

function openEditor(values, onSave) 
{
  let overlay = document.getElementById('editOverlay');
  if (!overlay) overlay = createEditor();
  
  overlay.querySelector('#edit_name').value   = values.name  ?? '';
  overlay.querySelector('#edit_code').value   = values.code  ?? '';
  overlay.querySelector('#edit_job').value    = values.job   ?? '';
  overlay.querySelector('#edit_level').value  = values.level ?? '';
  overlay.querySelector('#edit_attack').value = values.attack?? '';
  
  const campSelect = overlay.querySelector('#edit_camp');
  const campValue  = values.camp ?? '';
  if (campValue) {
    const exists = Array.from(campSelect.options).some(o => o.value === campValue || o.text === campValue);
    if (!exists) campSelect.add(new Option(campValue, campValue));
    campSelect.value = campValue;
  } else {
    campSelect.value = '';
  }
  
  const btnCancel = overlay.querySelector('#btn_cancel');
  const btnSave   = overlay.querySelector('#btn_save');
  const mask      = overlay.querySelector('#editLoadingMask');

  const setBusy = (busy) => {
    // é®ç½©é¡¯ç¤º/éš±è—
    mask.style.display = busy ? 'flex' : 'none';
    // é–å®š/è§£é–æŒ‰éˆ•èˆ‡è¡¨å–®
    btnSave.disabled = busy;
    btnCancel.disabled = busy;
    overlay.querySelectorAll('input, select, textarea').forEach(el => el.disabled = busy);
    // è®Šæ›´å„²å­˜æŒ‰éˆ•å…§å®¹ï¼ˆåŠ ä¸Š spinnerï¼‰
    if (busy) {
      btnSave.dataset._orig = btnSave.innerHTML;
      btnSave.innerHTML = `å„²å­˜ä¸­â€¦ <span class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true"></span>`;
    } else if (btnSave.dataset._orig) {
      btnSave.innerHTML = btnSave.dataset._orig;
      delete btnSave.dataset._orig;
    }
  };

  const close = () => overlay.remove();
  btnCancel.onclick = () => { if (!btnCancel.disabled) close(); };
  
  btnSave.onclick = async () => 
  {
    // é˜²é‡è¤‡è§¸ç™¼ï¼ˆæ¥µçŸ­æ™‚é–“é€£é»ï¼‰
    if (btnSave.disabled) return;

    const updated = {
      name:   overlay.querySelector('#edit_name').value.trim(),
      code:   overlay.querySelector('#edit_code').value.trim(),
      job:    overlay.querySelector('#edit_job').value.trim(),
      level:  overlay.querySelector('#edit_level').value.trim(),
      attack: overlay.querySelector('#edit_attack').value.trim(),
      camp:   overlay.querySelector('#edit_camp').value.trim(),
    };
    const isNew = !!values.__isNew;

    if (!GAS_UPDATE_URL || GAS_UPDATE_URL.includes('/dev')) {
      alert('è«‹è¨­å®šæ­£ç¢ºçš„ GAS_UPDATE_URLï¼ˆå¿…é ˆæ˜¯ /execï¼‰');
      return;
    }
    if (!updated.code) {
      alert('è§’è‰²ä»£ç¢¼ä¸å¯ç‚ºç©ºï¼ˆç”¨ä¾†å®šä½è¦æ›´æ–°çš„åˆ—ï¼‰');
      return;
    }

    try {
      setBusy(true); // ğŸ”’ é¡¯ç¤ºè¼‰å…¥ã€é–ä½æŒ‰éˆ•

      const form = new URLSearchParams();
      form.set('action', 'upsertByCode');
      form.set('code',   updated.code);
      form.set('name',   updated.name);
      form.set('job',    updated.job);
      form.set('level',  updated.level);
      form.set('attack', updated.attack);
      form.set('camp',   updated.camp);

      const resp = await fetch(GAS_UPDATE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString(),
        cache: 'no-store',
        redirect: 'follow'
      });

      const text = await resp.text();
      let result;
      try { result = JSON.parse(text); } catch {
        throw new Error('GAS å›å‚³é JSONï¼Œè«‹ç¢ºèª Web App ç”¨ /exec ä¸”ã€Œä»»ä½•äººã€å¯å­˜å–ã€‚');
      }
      if (!resp.ok || result.status !== 'ok') {
        throw new Error(result.message || 'æ›´æ–°/æ–°å¢å¤±æ•—');
      }

		  const t = resolveSheetTarget(DEFAULT_SHEET_URL);
		  loadFromSheet(t.sheetId, t.gid);

		  // â˜… æ–°å¢ï¼šæŠŠæ–°å¢äº‹ä»¶è¨˜éŒ„åˆ°ã€Œæ­·å²æ›´åLOGã€
		  try {
			await appendRenameLogToGAS({
			  code:   updated.code,
			  name:   updated.name,
			  // when å¯çœç•¥ï¼Œå°±æœƒç”¨ç¾åœ¨æ™‚é–“
			});
			// â¬‡ é€™è¡Œå¾ˆé—œéµï¼šæŠŠå¿«å–é‡æ–°è®€é€²ä¾†
			loadRenameLog(t.sheetId);
		  } catch (logErr) {
			console.warn('å¯«å…¥æ›´åLOGå¤±æ•—ï¼ˆä¸å½±éŸ¿æ–°å¢æœ¬é«”ï¼‰ï¼š', logErr);
			// å¯é¸ï¼šæç¤ºä½†ä¸æ“‹æµç¨‹
			// alert('è§’è‰²å·²æ–°å¢ï¼Œä½†å¯«å…¥æ›´åLOGå¤±æ•—ï¼š' + logErr.message);
		  }
		//if (isNew) {
		//} else {
		//  onSave?.(updated);
		//}
		alert(isNew ? 'æ–°å¢æˆåŠŸï¼' : 'æ›´æ–°æˆåŠŸï¼');
		close();
    } catch (e) {
      console.error(e);
      alert('é€å‡ºå¤±æ•—ï¼š' + e.message);
      setBusy(false); // âŒ å¤±æ•—æ‰æ¢å¾©ï¼Œå…è¨±é‡è©¦
    }
  };
}

/* =========================
   å…¬æœƒè·æ¥­åˆ†ä½ˆçµ±è¨ˆï¼ˆChart.jsï¼‰
========================= */
// è·æ¥­åç¨±æ­£è¦åŒ–ï¼ˆåŒç¾©åˆä½µï¼‰
function normalizeJob(raw) 
{
  if (!raw) return 'ï¼ˆæœªå¡«å¯«ï¼‰';
  let s = String(raw).trim();
  
  // çµ±ä¸€æ¨™é»
  s = s.replace(/ï¼Œ/g, 'ã€');
  
  // å°ç…§è¡¨ï¼ˆå·¦é‚Šæ˜¯æ¢ä»¶ï¼Œå³é‚Šæ˜¯æœ€çµ‚æ­¸æˆ¶åç¨±ï¼‰
  const map = [
    { test: /^(åå­—è»|è‹±é›„)$/ , to: 'è‹±é›„' },
    { test: /^(é¨å£«|è–é¨å£«)$/ , to: 'è–é¨å£«' },
    { test: /^(é¾é¨å£«|é»‘é¨å£«)$/ , to: 'é»‘é¨å£«' },
  
    { test: /^(ç«é­”å°å£«|å¤§é­”å°å£«\(ç«ã€æ¯’\))$/ , to: 'å¤§é­”å°å£«(ç«ã€æ¯’)' },
    { test: /^(å†°é­”å°å£«|å¤§é­”å°å£«\(å†°ã€é›·\))$/ , to: 'å¤§é­”å°å£«(å†°ã€é›·)' },
  
    { test: /^(ç¥­å¸|ä¸»æ•™)$/ , to: 'ä¸»æ•™' },
    { test: /^(éŠä¿ |ç®­ç¥)$/ , to: 'ç®­ç¥' },
    { test: /^(ç‹™æ“Šæ‰‹|ç¥å°„æ‰‹)$/ , to: 'ç¥å°„æ‰‹' },
  
    { test: /^(æš—æ®ºè€…|å¤œä½¿è€…)$/ , to: 'å¤œä½¿è€…' },
    { test: /^(ç¥å·|æš—å½±ç¥å·)$/ , to: 'æš—å½±ç¥å·' },
  
    { test: /^(æ ¼é¬¥å®¶|æ‹³éœ¸)$/ , to: 'æ‹³éœ¸' },
    { test: /^(ç¥æ§æ‰‹|æ§ç¥)$/ , to: 'æ§ç¥' },
  
    { test: /^åˆæ–°è€…$/, to: 'åˆæ–°è€…' } // ä¾ä½ æä¾›çš„å­—æ¨£
  ];
  
  for (const rule of map) {
    if (rule.test.test(s)) return rule.to;
  }
  return s; // å…¶ä»–è·æ¥­ç¶­æŒåŸå
}

/* ===== é¡è‰²å°ç…§ï¼ˆä¾ä½ æŒ‡å®šçš„è‰²ç³»ï¼‰ ===== */
const JOB_COLOR = {
  'è‹±é›„':            '#FFD24D', // é»ƒè‰²
  'è–é¨å£«':          '#F5F5F0', // å¥¶ç™½è‰²
  'é»‘é¨å£«':          '#1F1F1F', // é»‘è‰²
  
  'å¤§é­”å°å£«(ç«ã€æ¯’)': '#FF9999', // æ·ºç´…è‰²
  'å¤§é­”å°å£«(å†°ã€é›·)': '#99CCFF', // æ·ºè—è‰²
  'ä¸»æ•™':            '#FFF3B0', // æ·¡é»ƒè‰²
  'ç®­ç¥':            '#4CAF50', // ç¶ è‰²
  'ç¥å°„æ‰‹':          '#26A69A', // è—ç¶ è‰²
  
  'å¤œä½¿è€…':          '#5E35B1', // æ·±ç´«è‰²
  'æš—å½±ç¥å·':        '#4A4A4A', // é»‘ç°è‰²
  'æ‹³éœ¸':            '#D4AF37', // é‡‘è‰²
  'æ§ç¥':            '#E0E0E0', // ç™½ç°è‰²
  'åˆæ–°è€…':          '#FFFFFF'  // ç™½è‰²
};

// å–å¾—é¡è‰²ï¼ˆæœªçŸ¥è·æ¥­çµ¦ä¸­æ€§ç°ï¼‰
function getJobColor(name) 
{
  return JOB_COLOR[name] || '#9E9E9E';
}

// ç™½/å¥¶ç™½ç­‰å¾ˆæ·ºçš„é¡è‰²åŠ æ·±é‚Šæ¡†ï¼Œå…¶ä»–çµ±ä¸€æ·±é‚Šæ¡†ï¼Œè®“åˆ‡ç‰‡æœ‰ç•Œç·š
function getJobBorderColor(name) 
{
  const c = (JOB_COLOR[name] || '').toLowerCase();
  if (c === '#ffffff' || c === '#f5f5f0' || c === '#fff3b0' || c === '#ff9999' || c === '#99ccff') {
    return '#333333';
  }
  return '#222222';
}

// ç”Ÿæˆçµ±è¨ˆè³‡æ–™ï¼ˆä¸å«å¤–æ´å¤§å¤§ï¼‰ï¼‹ åå–®
function buildJobStatsData() {
  const source = Array.isArray(lastData) ? lastData : [];
    // åŒæ™‚æ’é™¤ camp ç‚ºã€Œå¤–æ´å¤§å¤§ã€æˆ–ã€Œé›¢ç‡Ÿã€
  const EXCLUDE = new Set(['å¤–æ´å¤§å¤§', 'é›¢ç‡Ÿ']);
  const rows = source.filter(r => !EXCLUDE.has((r?.camp || '').trim()));

  const counter = Object.create(null);
  const namesByJob = Object.create(null);

  for (const r of rows) {
    const key = normalizeJob(r?.job);
    counter[key] = (counter[key] || 0) + 1;

    if (!namesByJob[key]) namesByJob[key] = [];
    if (r?.name) namesByJob[key].push(r.name);
  }

  // ä¾æ•¸é‡æ’åºï¼ˆå¤šâ†’å°‘ï¼‰
  const entries = Object.entries(counter).sort((a,b) => b[1] - a[1]);

  // ä¹ŸæŠŠåå–®ä¾ç…§è·æ¥­é †åºåšå°é½Šï¼ˆåå–®å…§ä¾å­—æ¯åºï¼‰
  const labels = entries.map(e => e[0]);
  for (const k of Object.keys(namesByJob)) {
    namesByJob[k].sort((a,b) => a.localeCompare(b, 'zh-Hant'));
  }

  return {
    labels,
    values: entries.map(e => e[1]),
    total: rows.length,
    namesByJob
  };
}

let _jobChartInstance = null;
let _jobStatsCache = null; // æš«å­˜ namesByJob ç­‰

function renderHitList(jobName, list) {
  const box = document.getElementById('jobHitList');
  if (!box) return;
  if (!list || list.length === 0) {
    box.innerHTML = `<span class="text-muted">ï¼ˆæ²’æœ‰è³‡æ–™ï¼‰</span>`;
    return;
  }
  const items = list.map(n => `<li class="list-group-item py-1">${n}</li>`).join('');
  box.innerHTML = `
    <div class="mb-2"><b>${jobName}</b>ã€€<span class="badge text-bg-secondary">${list.length} äºº</span></div>
    <ul class="list-group list-group-flush small">${items}</ul>
  `;
}

function renderJobChart() {
  const ctx = document.getElementById('jobStatsCanvas');
  if (!ctx) return;

  const data = buildJobStatsData();
  _jobStatsCache = data; // å­˜èµ·ä¾†çµ¦ onClick ç”¨

  const bgColors = data.labels.map((name) => getJobColor(name));
  const borderColors = data.labels.map((name) => getJobBorderColor(name));

  const chartData = {
    labels: data.labels,
    datasets: [{
      label: 'äººæ•¸',
      data: data.values,
      backgroundColor: bgColors,
      borderColor: borderColors,
      borderWidth: 1.5,
      hoverOffset: 6
    }]
  };

  const options = {
    responsive: true,
    plugins: {
      legend: { display: true, position: 'bottom' },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const value = ctx.parsed;
            const total = data.total || 1;
            const pct = (value * 100 / total).toFixed(1);
            return `${ctx.label}: ${value} äººï¼ˆ${pct}%ï¼‰`;
          }
        }
      },
      title: {
        display: true,
        text: `å…¬æœƒè·æ¥­åˆ†ä½ˆï¼ˆç¸½æ•¸ï¼š${data.total}ï¼‰`
      }
    },
    // â˜… é€™è£¡åŠ é»æ“Šäº‹ä»¶
    onClick: (evt, elements) => {
      const chart = evt.chart;
      // å¦‚æœé»åˆ°åˆ‡ç‰‡
      if (elements && elements.length > 0) {
        const idx = elements[0].index;
        const jobName = chart.data.labels[idx];
        const list = _jobStatsCache?.namesByJob?.[jobName] || [];
        renderHitList(jobName, list);
      } else {
        // é»åœ¨ç©ºç™½è™•æ™‚ï¼Œæ¸…ç©ºå³é‚Š
        renderHitList('', []);
      }
    }
  };

  if (_jobChartInstance) {
    _jobChartInstance.data = chartData;
    _jobChartInstance.options = options;
    _jobChartInstance.update();
  } else {
    _jobChartInstance = new Chart(ctx, { type: 'doughnut', data: chartData, options });
  }

  // ç¬¬ä¸€æ¬¡æ‰“é–‹åœ–è¡¨æ™‚ï¼ŒæŠŠå³å´æ¸…ç©ºæç¤º
  renderHitList('', []);
}


// Guide åˆ†é æŒ‰éˆ•åˆ‡æ›ï¼šåªåˆ‡æ›ã€Œbutton.nav-linkã€å°æ‡‰çš„é¢æ¿
$('#guideTabs').on('click', 'button.nav-link', function () {
  const $btn = $(this);
  const targetSel = $btn.data('target'); // e.g. "#pane-onep"

  // åˆ‡ active æ¨£å¼ï¼ˆåªæ”¹åŒä¸€åˆ—çš„ nav-linkï¼‰
  $('#guideTabs .nav-link').removeClass('active');
  $btn.addClass('active');

  // é¡¯ç¤ºå°æ‡‰é¢æ¿
  $('.tab-pane').addClass('d-none');
  $(targetSel).removeClass('d-none');
});

// ====== ï¼ˆé‡è¦ï¼‰åˆªé™¤ä½ åŸæœ¬åœ¨åº•éƒ¨é‡è¤‡çš„å…©å€‹äº‹ä»¶ç¶å®šï¼Œé¿å…å†æ¬¡ new èˆ‡é‡è¤‡ç¶å®š ======
// ï¼ˆå·²åœ¨å‰é¢çµ±ä¸€ç¶å®š #btnJobStats èˆ‡ #jobStatsModal hidden äº‹ä»¶ï¼‰
/* ========= è®“åˆ†é è‡ªå‹•åˆ‡åˆ°è©²åˆ—æ‰€åœ¨ç‡Ÿå€ï¼ˆè‹¥æœ‰éœ€è¦ï¼‰ ========= */
function resolveTabByCamp(campText){
  const t = (campText||'').trim();
  if (/^æ™®æ‹‰[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ç‡Ÿ$/.test(t)) return 'latus';
  if (/^å›°æ‹‰[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ç‡Ÿ$/.test(t)) return 'latushard';
  if (/^ç‚é­”[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]ç‡Ÿ$/.test(t)) return 'zakum';
  if (t === 'è¨“ç·´ç‡Ÿ' || t === 'å¤–æ´å¤§å¤§') return 'trainext';
  return currentTab; // ä¸è®Š
}

/* ========= æ²å‹• + é«˜äº® ========= */
function scrollToRowByCode(code, campOptional){
  if (!code) return;

  // 1) è‹¥æœ‰æä¾›ç‡Ÿå€ï¼Œå…ˆåˆ‡åˆ°æ­£ç¢ºåˆ†é ï¼ˆé¿å…æ‰¾ä¸åˆ°ï¼‰
  if (campOptional){
    const tab = resolveTabByCamp(campOptional);
    if (tab !== currentTab) setTab(tab);
  }

  // 2) è¨­å€‹å°å»¶é²ï¼Œç­‰åˆ†é é‡ç¹ªå®Œå†æ‰¾å…ƒç´ 
  setTimeout(() => {
    const safeId = String(code).trim().replace(/[^a-zA-Z0-9_-]/g,'_');
    const tr = document.getElementById(`row-${safeId}`);
    if (!tr) {
      // æ‰¾ä¸åˆ°å°±ä¸è™•ç†
      return;
    }

    // æ²åˆ°ç•«é¢ä¸­å¤®
    tr.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // é«˜äº®å‹•ç•«ï¼ˆåŠ  class -> ç­‰å‹•ç•«å®Œç§»é™¤ï¼‰
    tr.classList.remove('row-pulse'); // å…ˆç§»é™¤ä¸€æ¬¡ï¼Œæ–¹ä¾¿é€£çºŒé»
    // è§¸ç™¼ reflow è®“å‹•ç•«å¯é‡æ’­
    void tr.offsetWidth;
    tr.classList.add('row-pulse');

    // 2 ç§’å¾Œç§»é™¤ classï¼ˆèˆ‡å‹•ç•«æ™‚é–“å°é½Šï¼‰
    setTimeout(() => tr.classList.remove('row-pulse'), 2000);
  }, 80);
}

// æœå°‹çµæœã€Œå®šä½æ­¤åˆ—ã€æŒ‰éˆ•
$(document).on('click', '.btn-locate-row', function(){
  const code = $(this).data('code') || '';
  const camp = $(this).data('camp') || '';
  // é—œæ‰æœå°‹çµæœ Modal
  const modalEl = document.getElementById('searchResultModal');
  if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).hide();

  // æ²å‹• + é«˜äº®
  scrollToRowByCode(code, camp);
});

$(document).on('click', '.name-history-btn', function () {
  const name = $(this).data('name') || '';
  const code = $(this).data('code') || '';
  openRenameLogModal(name, code);
  // åŒæ­¥é«˜äº®ç›®å‰é€™ä¸€åˆ—
  scrollToRowByCode(code);
});

</script>

  <!---->
  <!-- è·æ¥­åˆ†ä½ˆçµ±è¨ˆ Modal -->
  <div class="modal fade" id="jobStatsModal" tabindex="-1" aria-labelledby="jobStatsLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="jobStatsLabel">å…¬æœƒè·æ¥­åˆ†ä½ˆçµ±è¨ˆï¼ˆä¸å«å¤–æ´å¤§å¤§ï¼‰</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
      <div class="row g-3">
      <div class="col-12 col-lg-7">
        <canvas id="jobStatsCanvas" height="220"></canvas>
      </div>
      <div class="col-12 col-lg-5">
        <div class="border rounded p-3 h-100" style="background: rgba(0,0,0,.02);">
        <h6 class="mb-2">è¢«çµ±è¨ˆåˆ°çš„è§’è‰²</h6>
        <div id="jobHitList" class="small text-muted">ï¼ˆé»ä¸€ä¸‹å·¦é‚Šçš„çµ±è¨ˆåœ–åˆ‡ç‰‡ï¼Œé€™è£¡æœƒåˆ—å‡ºè§’è‰²åç¨±ï¼‰</div>
        </div>
      </div>
      </div>
      <small class="text-muted d-block mt-2">
      èªªæ˜ï¼šçµ±è¨ˆä¾†æºç‚ºåˆ—è¡¨è®€å…¥çš„ Google Sheetï¼›åŒç¾©è·æ¥­æœƒè‡ªå‹•åˆä½µï¼ˆå¦‚ã€Œåå­—è»=è‹±é›„ã€ï¼‰ã€‚
      </small>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
    </div>
    </div>
  </div>
  </div>
  <!---->
	<!-- æ­·å²æ›´åç´€éŒ„ Modal -->
	<div class="modal fade" id="renameLogModal" tabindex="-1" aria-labelledby="renameLogLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-scrollable">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="renameLogLabel">æ­·å²è§’è‰²æ›´åç´€éŒ„</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <div class="modal-body">
			<div class="small text-muted mb-2" id="renameLogTarget">æŸ¥è©¢è§’è‰²ï¼šâ€”</div>
			<div id="renameLogList" class="border rounded p-2" style="min-height:120px;">
			  ï¼ˆå°šç„¡ç´€éŒ„ï¼‰
			</div>
		  </div>
		  <div class="modal-footer">
			<button class="btn btn-primary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
		  </div>
		</div>
	  </div>
	</div>
  <!-- æœå°‹çµæœ Modal -->
	<div class="modal fade" id="searchResultModal" tabindex="-1" aria-labelledby="searchResultLabel" aria-hidden="true">
	  <div class="modal-dialog modal-lg modal-dialog-scrollable">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="searchResultLabel">æœå°‹çµæœ</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <div class="modal-body">
			<div class="small text-muted mb-2" id="searchQueryEcho">é—œéµå­—ï¼šâ€”</div>
			<div class="table-responsive">
			  <table class="table table-sm table-hover align-middle">
				<thead class="table-secondary">
				  <tr>
					<th style="width:20%;">è§’è‰²åç¨±</th>
					<th style="width:12%;">è§’è‰²ä»£ç¢¼</th>
					<th style="width:18%;">è§’è‰²è·æ¥­</th>
					<th style="width:10%;">ç­‰ç´š</th>
					<th style="width:10%;">ä¹¾è¡¨</th>
					<th style="width:15%;">æ‰€åœ¨ç‡Ÿå€</th>
					<th style="width:15%;">æ›´åç´€éŒ„</th>
				  </tr>
				</thead>
				<tbody id="searchResultBody">
				  <tr><td colspan="7" class="text-center text-muted">ç„¡ç¬¦åˆé …ç›®</td></tr>
				</tbody>
			  </table>
			</div>
		  </div>
		  <div class="modal-footer">
			<button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é—œé–‰</button>
		  </div>
		</div>
	  </div>
	</div>
</body>
</html>
